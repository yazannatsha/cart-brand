<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cart Brand  (Blue)</title>
<style>
  :root{--bg:#0a1430;--panel:#0f1d3a;--ink:#eaf2ff;--muted:#9fb2d8;--line:#1b2a52;--accent:#3b82f6;--accent2:#1e3a8a}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Arial}
  header{padding:14px 12px;text-align:center;background:linear-gradient(90deg,#0f1e3d,#0d1730);font-weight:800}
  nav{display:flex;gap:12px;padding:10px;background:var(--panel);position:sticky;top:0;z-index:10}
  nav button{flex:1;padding:10px;border-radius:10px;border:1px solid var(--line);background:#112a55;color:#fff;cursor:pointer}
  nav button.active{background:var(--accent2)}
  section{display:none;padding:18px}
  section.active{display:block}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
  h3{margin:0 0 10px 0}
  label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
  input,select,button,textarea{width:100%;padding:9px;border-radius:10px;border:1px solid var(--line);background:#0b1a3a;color:var(--ink);margin-bottom:10px}
  button.primary{background:var(--accent);border:0;color:#fff;cursor:pointer}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:160px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--line);padding:8px;text-align:center}
  th{background:#0f1f46;position:sticky;top:0}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi .box{background:#0e1a39;border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi .label{color:var(--muted);font-size:12px}
  .kpi .val{font-size:22px;font-weight:800;margin-top:4px}
  .tools{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#163062;border:1px solid #254382;font-size:11px}
  .danger{background:#8b1d1d;border-color:#a43a3a}
</style>
</head>
<body>
<header>Cart Brand | Firebase v3</header>

<nav>
  <button class="active" onclick="showTab('dash')">لوحة التحكم</button>
  <button onclick="showTab('orders')">الطلبات</button>
  <button onclick="showTab('suppliers')">الموردون</button>
  <button onclick="showTab('purchases')">المشتريات</button>
  <button onclick="showTab('products')">الموديلات</button>
</nav>

<!-- Dashboard -->
<section id="dash" class="active">
  <div class="card">
    <h3>لوحة التحكم</h3>
    <div class="kpi">
      <div class="box"><div class="label">إجمالي الطلبات</div><div class="val" id="k-orders">0</div></div>
      <div class="box"><div class="label">إجمالي المبيعات</div><div class="val" id="k-sales">0 ₪</div></div>
      <div class="box"><div class="label">إجمالي المشتريات</div><div class="val" id="k-purchases">0 ₪</div></div>
      <div class="box"><div class="label">الربح</div><div class="val" id="k-profit">0 ₪</div></div>
    </div>
    <div class="kpi" style="margin-top:10px">
      <div class="box"><div class="label">الرصيد للموردين</div><div class="val" id="k-sup-balance">0 ₪</div></div>
      <div class="box"><div class="label">عدد الموردين</div><div class="val" id="k-suppliers">0</div></div>
      <div class="box"><div class="label">عدد الموديلات</div><div class="val" id="k-products">0</div></div>
      <div class="box"><div class="label">متوسط هامش الربح</div><div class="val" id="k-margin">0%</div></div>
    </div>
  </div>
</section>

<!-- Orders -->
<section id="orders">
  <div class="card">
    <h3>إضافة طلب</h3>
    <div class="row">
      <div class="col"><label>رقم الموديل</label><input id="o-model" placeholder="CB-101"></div>
      <div class="col"><label>المقاس</label><input id="o-size" type="number"></div>
      <div class="col"><label>اللون</label><input id="o-color"></div>
      <div class="col"><label>الكمية</label><input id="o-qty" type="number" value="1"></div>
      <div class="col"><label>سعر البيع للوحدة</label><input id="o-price" type="number" placeholder="يتعبى تلقائياً من الموديلات إذا موجود"></div>
      <div class="col"><label>اسم الزبون</label><input id="o-customer"></div>
      <div class="col"><label>الهاتف</label><input id="o-phone"></div>
      <div class="col"><label>العنوان</label><input id="o-address"></div>
      <div class="col"><label>الحالة</label>
        <select id="o-status">
          <option>قيد التجهيز</option><option>جاهز</option>
          <option>قيد التوصيل</option><option>مغلق</option><option>تبديل</option>
        </select>
      </div>
    </div>
    <button class="primary" id="btnAddOrder">حفظ الطلب</button>
  </div>

  <div class="card">
    <h3>الطلبات</h3>
    <div class="tools">
      <input id="order-search" placeholder="بحث باسم الزبون/الموديل">
      <select id="order-filter">
        <option value="">كل الحالات</option>
        <option>قيد التجهيز</option><option>جاهز</option>
        <option>قيد التوصيل</option><option>مغلق</option><option>تبديل</option>
      </select>
    </div>
    <table>
      <thead><tr><th>#</th><th>الموديل</th><th>مقاس</th><th>لون</th><th>كمية</th><th>سعر</th><th>المجموع</th><th>زبون</th><th>هاتف</th><th>عنوان</th><th>حالة</th><th>إجراء</th></tr></thead>
      <tbody id="orders-body"></tbody>
    </table>
  </div>
</section>

<!-- Suppliers -->
<section id="suppliers">
  <div class="card">
    <h3>إضافة مورد</h3>
    <div class="row">
      <div class="col"><label>اسم المورد</label><input id="s-name"></div>
      <div class="col"><label>الهاتف</label><input id="s-phone"></div>
      <div class="col"><label>&nbsp;</label><button class="primary" id="btnAddSupplier">إضافة مورد</button></div>
    </div>
  </div>

  <div class="card">
    <h3>المورد المختار</h3>
    <div class="row">
      <div class="col"><label>اختر المورد</label><select id="sup-select"></select></div>
    </div>
  </div>

  <div class="card">
    <h3>مدفوعات المورد</h3>
    <div class="row">
      <div class="col"><label>المبلغ</label><input id="pa-amount" type="number"></div>
      <div class="col"><label>ملاحظات</label><input id="pa-notes" placeholder="كاش/تحويل..."></div>
      <div class="col"><label>&nbsp;</label><button class="primary" id="btnAddPayment">تسجيل دفعة</button></div>
    </div>
    <table>
      <thead><tr><th>المبلغ</th><th>ملاحظات</th></tr></thead>
      <tbody id="payments-body"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>ملخص المورد</h3>
    <div class="kpi">
      <div class="box"><div class="label">إجمالي مشتريات</div><div class="val" id="sum-pu">0 ₪</div></div>
      <div class="box"><div class="label">إجمالي مدفوعات</div><div class="val" id="sum-pa">0 ₪</div></div>
      <div class="box"><div class="label">الرصيد المتبقي</div><div class="val" id="sum-bal">0 ₪</div></div>
      <div class="box"><div class="label">عدد الأزواج</div><div class="val" id="sum-items">0</div></div>
    </div>
  </div>
</section>

<!-- Purchases -->
<section id="purchases">
  <div class="card">
    <h3>إضافة مشتريات</h3>
    <div class="row">
      <div class="col"><label>المورد</label><select id="pu-supplier"></select></div>
      <div class="col"><label>رقم الموديل</label><input id="pu-model" placeholder="CB-101"></div>
      <div class="col"><label>المقاس</label><input id="pu-size" type="number"></div>
      <div class="col"><label>اللون</label><input id="pu-color"></div>
      <div class="col"><label>العدد</label><input id="pu-qty" type="number" value="1"></div>
      <div class="col"><label>سعر الجملة للوحدة</label><input id="pu-cost" type="number" placeholder="يتعبى تلقائياً من الموديلات"></div>
    </div>
    <button class="primary" id="btnAddPurchase">حفظ شراء</button>
  </div>

  <div class="card">
    <h3>سجل المشتريات</h3>
    <table>
      <thead><tr><th>#</th><th>المورد</th><th>موديل</th><th>مقاس</th><th>لون</th><th>عدد</th><th>سعر الجملة</th><th>الإجمالي</th></tr></thead>
      <tbody id="purchases-body"></tbody>
    </table>
  </div>
</section>

<!-- Products -->
<section id="products">
  <div class="card">
    <h3>إضافة/تحديث موديل</h3>
    <div class="row">
      <div class="col"><label>رقم الموديل</label><input id="p-model"></div>
      <div class="col"><label>سعر الجملة</label><input id="p-cost" type="number"></div>
      <div class="col"><label>&nbsp;</label><button class="primary" id="btnSaveProduct">حفظ/تحديث</button></div>
    </div>
  </div>
  <div class="card">
    <h3>قائمة الموديلات</h3>
    <table>
      <thead><tr><th>#</th><th>الموديل</th><th>سعر الجملة</th></tr></thead>
      <tbody id="products-body"></tbody>
    </table>
  </div>
</section>

<!-- Firebase (ESM CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, onSnapshot, query, where, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ------------ CONFIG (تم تعديل storageBucket للصيغة الصحيحة) ------------
  const firebaseConfig = {
    apiKey: "AIzaSyB8UdVOTqPmHPmiokEZ45JhXIU2mR0SE_8",
    authDomain: "cart-brand-app.firebaseapp.com",
    projectId: "cart-brand-app",
    storageBucket: "cart-brand-app.appspot.com",
    messagingSenderId: "743299975523",
    appId: "1:743299975523:web:a95880aad3311744606b56",
    measurementId: "G-MG9WBG5YT0"
  };

  // ------------ INIT ------------
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const cur = "₪";
  const fmt = n => (isNaN(+n)?0:+n).toLocaleString('ar-EG',{maximumFractionDigits:2})+" "+cur;
  const qs  = sel => document.querySelector(sel);

  function showTab(id){
    document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`nav button[onclick="showTab('${id}')"]`).classList.add('active');
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }
  window.showTab = showTab;

  // ------------ Collections ------------
  const C_PRODUCTS  = collection(db, "products");
  const C_ORDERS    = collection(db, "orders");
  const C_SUPPLIERS = collection(db, "suppliers");
  const C_PURCHASES = collection(db, "purchases");
  const C_PAYMENTS  = collection(db, "payments");

  // ------------ Products cache ------------
  let productsMap = new Map();
  onSnapshot(C_PRODUCTS, snap=>{
    productsMap = new Map();
    const tb = qs('#products-body'); tb.innerHTML = "";
    let i=1;
    snap.forEach(d=>{
      const p = d.data();
      const key = (p.model||d.id).toLowerCase();
      productsMap.set(key, {...p, id:d.id});
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i++}</td><td>${p.model||d.id}</td><td>${fmt(p.cost||0)}</td>`;
      tb.appendChild(tr);
    });
    // Dashboard counter
    qs('#k-products').textContent = productsMap.size;
  });

  // Save/Update product
  qs('#btnSaveProduct').addEventListener('click', async ()=>{
    const model = qs('#p-model').value.trim();
    const cost  = +qs('#p-cost').value || 0;
    if(!model || cost<=0) return alert('اكتب الموديل والسعر');
    await setDoc(doc(db,'products', model), { model, cost, ts: serverTimestamp() });
    qs('#p-model').value=''; qs('#p-cost').value='';
  });

  // ------------ Orders ------------
  function hydratePriceFromModel(inputModelSel, priceSel){
    const m = qs(inputModelSel).value.trim().toLowerCase();
    const p = productsMap.get(m);
    if(p) qs(priceSel).value = p.cost || '';
  }
  qs('#o-model').addEventListener('input', ()=>hydratePriceFromModel('#o-model','#o-price'));

  qs('#btnAddOrder').addEventListener('click', async ()=>{
    const o = {
      model: qs('#o-model').value.trim(),
      size: +qs('#o-size').value || 0,
      color: qs('#o-color').value.trim(),
      qty: +qs('#o-qty').value || 0,
      price: +qs('#o-price').value || 0,
      customer: qs('#o-customer').value.trim(),
      phone: qs('#o-phone').value.trim(),
      address: qs('#o-address').value.trim(),
      status: qs('#o-status').value,
      ts: serverTimestamp()
    };
    if(!o.model || !o.size || !o.color || !o.qty || !o.customer) return alert('عبي الحقول الأساسية');
    if(o.price<=0){
      const pm = productsMap.get(o.model.toLowerCase());
      if(pm) o.price = +pm.cost || 0;
    }
    await addDoc(C_ORDERS, o);
    ['#o-model','#o-size','#o-color','#o-qty','#o-price','#o-customer','#o-phone','#o-address'].forEach(s=>qs(s).value='');
    qs('#o-status').value='قيد التجهيز';
  });

  let ordersData = []; // for search/filter
  function renderOrders(){
    const term = qs('#order-search').value.trim().toLowerCase();
    const f    = qs('#order-filter').value;
    const tb   = qs('#orders-body'); tb.innerHTML="";
    let i=1,totalSales=0,count=0;
    ordersData
      .filter(o=>{
        const text = `${o.model} ${o.customer}`.toLowerCase();
        const okT  = !term || text.includes(term);
        const okF  = !f || o.status===f;
        return okT && okF;
      })
      .forEach(o=>{
        const sale = (+o.price||0) * (+o.qty||0);
        totalSales += sale; count++;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i++}</td>
          <td>${o.model}</td>
          <td>${o.size}</td>
          <td>${o.color}</td>
          <td>${o.qty}</td>
          <td>${fmt(o.price)}</td>
          <td>${fmt(sale)}</td>
          <td>${o.customer}</td>
          <td>${o.phone||''}</td>
          <td>${o.address||''}</td>
          <td><span class="badge">${o.status||''}</span></td>
          <td><button class="danger" data-del="${o.id}">حذف</button></td>
        `;
        tb.appendChild(tr);
      });
    qs('#k-orders').textContent = count;
    // سنحدّث k-sales والربح لاحقاً بعد حساب المشتريات أيضاً
    currentSales = totalSales;
    updateProfit();
  }
  let currentSales = 0;
  let currentPurchases = 0;
  let suppliersBalance = 0;

  onSnapshot(C_ORDERS, snap=>{
    ordersData = [];
    snap.forEach(d=> ordersData.push({id:d.id, ...d.data()}));
    renderOrders();
  });

  // حذف طلب
  document.addEventListener('click', async (e)=>{
    const id = e.target?.dataset?.del;
    if(!id) return;
    if(confirm('حذف الطلب نهائياً؟')){
      await setDoc(doc(db,'orders',id), {__deleted:true}, {merge:true});
      // بدلاً من deleteDoc لتبسيط صلاحيات، نخفيه في العرض:
      ordersData = ordersData.filter(x=>x.id!==id);
      renderOrders();
    }
  });

  qs('#order-search').addEventListener('input', renderOrders);
  qs('#order-filter').addEventListener('change', renderOrders);

  // ------------ Suppliers ------------
  let suppliersCache = [];
  function refreshSupplierSelect(selId){
    const el = qs(selId); el.innerHTML="";
    suppliersCache.forEach(s=>{
      const opt=document.createElement('option');
      opt.value=s.id; opt.textContent=s.name; el.appendChild(opt);
    });
    if(!suppliersCache.length){
      const opt=document.createElement('option');
      opt.value=""; opt.textContent="لا يوجد موردون"; el.appendChild(opt);
    }
  }

  qs('#btnAddSupplier').addEventListener('click', async ()=>{
    const s = { name: qs('#s-name').value.trim(), phone: qs('#s-phone').value.trim(), ts: serverTimestamp() };
    if(!s.name) return alert('اكتب اسم المورد');
    await addDoc(C_SUPPLIERS, s);
    qs('#s-name').value=''; qs('#s-phone').value='';
  });

  onSnapshot(C_SUPPLIERS, snap=>{
    suppliersCache = [];
    snap.forEach(d=> suppliersCache.push({id:d.id, ...d.data()}));
    refreshSupplierSelect('#sup-select');
    refreshSupplierSelect('#pu-supplier');
    qs('#k-suppliers').textContent = suppliersCache.length;
  });

  // دفعات المورد
  qs('#btnAddPayment').addEventListener('click', async ()=>{
    const supplierId = qs('#sup-select').value;
    const amount = +qs('#pa-amount').value || 0;
    const notes  = qs('#pa-notes').value.trim();
    if(!supplierId || amount<=0) return alert('اختر المورد وأدخل المبلغ');
    await addDoc(C_PAYMENTS, { supplierId, amount, notes, ts: serverTimestamp() });
    qs('#pa-amount').value=''; qs('#pa-notes').value='';
    renderSupplierTables();
  });

  async function renderSupplierTables(){
    const supplierId = qs('#sup-select').value;
    const tbPay = qs('#payments-body'); tbPay.innerHTML="";
    if(!supplierId) return;
    // payments
    const qPay = query(C_PAYMENTS, where('supplierId','==',supplierId));
    const snapPay = await getDocs(qPay);
    let sumPa=0;
    snapPay.forEach(d=>{
      const p=d.data(); sumPa += (+p.amount||0);
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${fmt(p.amount)}</td><td>${p.notes||''}</td>`;
      tbPay.appendChild(tr);
    });

    // purchases by supplier
    const qP = query(C_PURCHASES, where('supplierId','==',supplierId));
    const snapP = await getDocs(qP);
    let sumPu=0, items=0;
    snapP.forEach(d=>{
      const p=d.data();
      const total = (+p.qty||0) * (+p.cost||0);
      sumPu += total; items += (+p.qty||0);
    });

    qs('#sum-pu').textContent = fmt(sumPu);
    qs('#sum-pa').textContent = fmt(sumPa);
    qs('#sum-bal').textContent = fmt(sumPu - sumPa);
    qs('#sum-items').textContent = items;
  }
  qs('#sup-select').addEventListener('change', renderSupplierTables);
  onSnapshot(C_PURCHASES, ()=>renderSupplierTables());
  onSnapshot(C_PAYMENTS,  ()=>renderSupplierTables());

  // ------------ Purchases ------------
  function hydrateCostFromModel(inputModelSel, costSel){
    const m = qs(inputModelSel).value.trim().toLowerCase();
    const p = productsMap.get(m);
    if(p) qs(costSel).value = p.cost || '';
  }
  qs('#pu-model').addEventListener('input', ()=>hydrateCostFromModel('#pu-model','#pu-cost'));

  qs('#btnAddPurchase').addEventListener('click', async ()=>{
    const supId = qs('#pu-supplier').value;
    const item = {
      supplierId: supId,
      model: qs('#pu-model').value.trim(),
      size: +qs('#pu-size').value || 0,
      color: qs('#pu-color').value.trim(),
      qty: +qs('#pu-qty').value || 0,
      cost: +qs('#pu-cost').value || 0,
      ts: serverTimestamp()
    };
    if(!supId) return alert('اختر المورد');
    if(!item.model || !item.size || !item.color || !item.qty) return alert('عبي بيانات الشراء');
    if(item.cost<=0){
      const pm = productsMap.get(item.model.toLowerCase());
      if(pm) item.cost = +pm.cost||0;
    }
    await addDoc(C_PURCHASES, item);
    ['#pu-model','#pu-size','#pu-color','#pu-qty','#pu-cost'].forEach(s=>qs(s).value='');
  });

  onSnapshot(C_PURCHASES, snap=>{
    const tb = qs('#purchases-body'); tb.innerHTML="";
    let i=1, total=0;
    snap.forEach(d=>{
      const p=d.data();
      const rowTotal = (+p.qty||0) * (+p.cost||0);
      total += rowTotal;
      const supName = suppliersCache.find(s=>s.id===p.supplierId)?.name || '—';
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${i++}</td><td>${supName}</td><td>${p.model}</td><td>${p.size}</td><td>${p.color}</td><td>${p.qty}</td><td>${fmt(p.cost)}</td><td>${fmt(rowTotal)}</td>`;
      tb.appendChild(tr);
    });
    currentPurchases = total;
    updateProfit();
  });

  // ------------ Profit & Dashboard ------------
  function updateProfit(){
    qs('#k-sales').textContent     = fmt(currentSales);
    qs('#k-purchases').textContent = fmt(currentPurchases);
    const profit = currentSales - currentPurchases;
    qs('#k-profit').textContent    = fmt(profit);

    // Suppliers balance (sum purchases - payments)
    computeSuppliersBalance().then(b=>{
      suppliersBalance = b;
      qs('#k-sup-balance').textContent = fmt(b);
      // margin
      const margin = currentSales>0 ? Math.max(0, profit/currentSales*100).toFixed(1) : 0;
      qs('#k-margin').textContent = margin + '%';
    });
  }

  async function computeSuppliersBalance(){
    const [pSnap, paySnap] = await Promise.all([ getDocs(C_PURCHASES), getDocs(C_PAYMENTS) ]);
    let pu=0, pa=0;
    pSnap.forEach(d=>{ const x=d.data(); pu += (+x.qty||0)*(+x.cost||0); });
    paySnap.forEach(d=>{ const x=d.data(); pa += (+x.amount||0); });
    return pu - pa;
  }
</script>
</body>
</html>
