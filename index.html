<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>نظام مبيعات الأحذية | سحابي (Firestore)</title>
<meta name="theme-color" content="#151926"/>
<style>
  :root{--gap:12px;--pad:14px;--radius:10px}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial; background:#0f1115; color:#eef; margin:0}
  header{position:sticky;top:0;background:#151926;border-bottom:1px solid #23283a; z-index:10}
  header .bar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{font-weight:800;font-size:18px}
  nav{display:flex;gap:8px;flex-wrap:wrap}
  nav button{background:#1b2030;color:#cfd3ff;border:1px solid #2a3250;padding:8px 12px;border-radius:8px;cursor:pointer}
  nav button.active{background:#35406a;color:#fff}
  main{padding:16px;max-width:1200px;margin:auto}
  .card{background:#151926;border:1px solid #23283a;border-radius:var(--radius);padding:var(--pad);margin-bottom:var(--gap)}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:var(--gap)}
  .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
  label{display:block;font-size:12px;color:#94a3b8;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px;background:#0f1320;border:1px solid #29314a;border-radius:8px;color:#e8edff}
  input[type="number"]{text-align:center}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #23283a;padding:10px;text-align:center}
  th{background:#1b2030;color:#b9c1ff;position:sticky;top:0}
  .muted{color:#94a3b8}
  .row{display:flex;flex-wrap:wrap;gap:var(--gap)}
  .btn{background:#4052b6;color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  .btn.alt{background:#26304e}.btn.red{background:#b64040}.btn.green{background:#2e8b57}
  .section-title{margin:4px 0 10px;font-size:14px;color:#c5ccff}
  .stat{background:#121624;border:1px solid #23283a;border-radius:10px;padding:10px;text-align:center}
  .stat .big{font-weight:700;font-size:20px;margin-top:6px}
  .mono{font-family:ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .warning{color:#ffd16a}.success{color:#8cffbf}.danger{color:#ff8c8c}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="brand">نظام مبيعات الأحذية • سحابي</div>
    <nav id="tabs">
      <button data-tab="dashboard" class="active">لوحة التحكم</button>
      <button data-tab="sales">المبيعات</button>
      <button data-tab="purchases">المشتريات</button>
      <button data-tab="suppliers">الموردون</button>
      <button data-tab="customers">الزبائن</button>
    </nav>
  </div>
</header>

<main>
  <section id="dashboard" class="card">
    <div class="section-title">ملخص سريع</div>
    <div class="grid">
      <div class="col-3 stat"><div class="muted">إجمالي المبيعات</div><div class="big" id="stat-total-sales">0</div></div>
      <div class="col-3 stat"><div class="muted">إجمالي التكلفة</div><div class="big" id="stat-total-cogs">0</div></div>
      <div class="col-3 stat"><div class="muted">الربح الإجمالي</div><div class="big" id="stat-gross-profit">0</div></div>
      <div class="col-3 stat"><div class="muted">متوسط الهامش</div><div class="big" id="stat-margin">0%</div></div>
    </div>
  </section>

  <section id="sales" class="card" hidden>
    <div class="section-title">تسجيل بيع جديد</div>
    <div class="grid">
      <div class="col-3"><label>تاريخ</label><input type="date" id="sale-date"></div>
      <div class="col-3"><label>رقم الطلب</label><input type="text" id="sale-order"></div>
      <div class="col-3"><label>اسم الزبون</label><input type="text" id="sale-customer" list="customersList"><datalist id="customersList"></datalist></div>
      <div class="col-3"><label>الهاتف</label><input type="text" id="sale-phone"></div>
      <div class="col-3"><label>الموديل</label><input type="text" id="sale-model" list="modelsList"><datalist id="modelsList"></datalist></div>
      <div class="col-3"><label>اللون</label><input type="text" id="sale-color"></div>
      <div class="col-3"><label>المقاس</label><input type="number" id="sale-size" min="20" max="50" step="1"></div>
      <div class="col-3"><label>الكمية</label><input type="number" id="sale-qty" min="1" step="1" value="1"></div>
      <div class="col-3"><label>سعر البيع</label><input type="number" id="sale-price" min="0" step="0.01"></div>
      <div class="col-3"><label>خصم إجمالي</label><input type="number" id="sale-discount" min="0" step="0.01" value="0"></div>
      <div class="col-3"><label>شحن مدفوع</label><input type="number" id="sale-ship" min="0" step="0.01" value="0"></div>
      <div class="col-3"><label>ملاحظات</label><input type="text" id="sale-notes"></div>
    </div>
    <div class="row"><button class="btn green" id="btn-add-sale">إضافة البيع</button><div class="muted mono" id="sale-feedback"></div></div>
    <div class="section-title" style="margin-top:14px">سجل المبيعات</div>
    <div style="max-height:360px; overflow:auto">
      <table id="sales-table"><thead><tr>
        <th>تاريخ</th><th>طلب</th><th>زبون</th><th>هاتف</th><th>موديل</th><th>لون</th><th>مقاس</th><th>كمية</th><th>سعر</th><th>خصم</th><th>شحن</th><th>إجمالي</th><th>التكلفة</th><th>الربح</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="purchases" class="card" hidden>
    <div class="section-title">إدخال مشتريات (مقاس + لون)</div>
    <div class="grid">
      <div class="col-3"><label>تاريخ</label><input type="date" id="pur-date"></div>
      <div class="col-3"><label>المورد</label><input type="text" id="pur-supplier" list="suppliersList"><datalist id="suppliersList"></datalist></div>
      <div class="col-3"><label>الموديل</label><input type="text" id="pur-model"></div>
      <div class="col-3"><label>اللون</label><input type="text" id="pur-color"></div>
      <div class="col-3"><label>المقاس</label><input type="number" id="pur-size" min="20" max="50" step="1"></div>
      <div class="col-3"><label>الكمية</label><input type="number" id="pur-qty" min="1" step="1" value="1"></div>
      <div class="col-3"><label>سعر الجملة</label><input type="number" id="pur-cost" min="0" step="0.01"></div>
      <div class="col-6"><label>ملاحظات</label><input type="text" id="pur-notes"></div>
    </div>
    <div class="row"><button class="btn green" id="btn-add-purchase">إضافة شراء</button><div class="muted mono" id="pur-feedback"></div></div>

    <div class="section-title" style="margin-top:14px">سجل المشتريات</div>
    <div style="max-height:360px; overflow:auto">
      <table id="purchases-table"><thead><tr>
        <th>تاريخ</th><th>مورد</th><th>موديل</th><th>لون</th><th>مقاس</th><th>كمية</th><th>سعر</th><th>الإجمالي</th><th>ملاحظات</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="suppliers" class="card" hidden>
    <div class="section-title">إدارة الموردين</div>
    <div class="grid">
      <div class="col-4"><label>اسم المورد</label><input type="text" id="sup-name"></div>
      <div class="col-4"><label>الهاتف</label><input type="text" id="sup-phone"></div>
      <div class="col-4"><label>ملاحظات</label><input type="text" id="sup-notes"></div>
    </div>
    <div class="row"><button class="btn green" id="btn-add-supplier">إضافة مورد</button><div class="muted mono" id="sup-feedback"></div></div>

    <div class="section-title" style="margin-top:12px">قائمة الموردين</div>
    <div style="max-height:380px; overflow:auto">
      <table id="suppliers-table"><thead><tr>
        <th>المورد</th><th>الهاتف</th><th>إجمالي مشتريات</th><th>ما دفعته</th><th>الرصيد</th><th>رابط صفحة المورد</th>
      </tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="customers" class="card" hidden>
    <div class="section-title">دفتر الزبائن</div>
    <div class="grid">
      <div class="col-4"><label>اسم الزبون</label><input type="text" id="cus-name"></div>
      <div class="col-4"><label>الهاتف</label><input type="text" id="cus-phone"></div>
      <div class="col-4"><label>المدينة</label><input type="text" id="cus-city"></div>
      <div class="col-12"><label>العنوان</label><input type="text" id="cus-address"></div>
    </div>
    <div class="row"><button class="btn green" id="btn-add-customer">إضافة زبون</button><div class="muted mono" id="cus-feedback"></div></div>

    <div class="section-title" style="margin-top:12px">قائمة الزبائن</div>
    <div style="max-height:380px; overflow:auto">
      <table id="customers-table"><thead><tr><th>الاسم</th><th>الهاتف</th><th>المدينة</th><th>العنوان</th></tr></thead><tbody></tbody></table>
    </div>
  </section>
</main>

<!-- Public Supplier View -->
<section id="public-supplier" class="card" hidden style="margin:16px">
  <div class="section-title">صفحة المورد</div>
  <div class="grid">
    <div class="col-6 stat"><div class="muted">اسم المورد</div><div class="big" id="pub-sup-name">—</div></div>
    <div class="col-6 stat"><div class="muted">الهاتف</div><div class="big" id="pub-sup-phone">—</div></div>
    <div class="col-4 stat"><div class="muted">إجمالي مشترياتك منه</div><div class="big" id="pub-total-purchases">0</div></div>
    <div class="col-4 stat"><div class="muted">ما دفعته له</div><div class="big" id="pub-total-payments">0</div></div>
    <div class="col-4 stat"><div class="muted">الرصيد المتبقي</div><div class="big" id="pub-balance">0</div></div>
  </div>
  <div class="section-title" style="margin-top:12px">المشتريات المفصلة</div>
  <div style="max-height:380px; overflow:auto">
    <table id="pub-purchases-table"><thead><tr>
      <th>تاريخ</th><th>موديل</th><th>لون</th><th>مقاس</th><th>كمية</th><th>سعر جملة</th><th>الإجمالي</th>
    </tr></thead><tbody></tbody></table>
  </div>
</section>

<script type="module">
import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {{ getFirestore, collection, doc, addDoc, getDoc, onSnapshot, serverTimestamp, query, where, orderBy }} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {{
  apiKey: "{firebase_config['apiKey']}",
  authDomain: "{firebase_config['authDomain']}",
  projectId: "{firebase_config['projectId']}",
  storageBucket: "{firebase_config['storageBucket']}",
  messagingSenderId: "{firebase_config['messagingSenderId']}",
  appId: "{firebase_config['appId']}",
}};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const tabs = document.querySelectorAll('#tabs button');
const sections = ["dashboard","sales","purchases","suppliers","customers"];
tabs.forEach(btn=>btn.addEventListener('click',()=>{ tabs.forEach(b=>b.classList.remove('active')); btn.classList.add('active'); sections.forEach(id=>document.getElementById(id).hidden=true); document.getElementById(btn.dataset.tab).hidden=false; }));

const currency = () => "₪";
const fmt = n => isNaN(+n) ? "0" : (+n).toLocaleString('ar-EG',{minimumFractionDigits:2,maximumFractionDigits:2})+" "+currency();
const percent = p => isNaN(+p) ? "0%" : (+(p*100)).toFixed(2)+"%";
const today = () => new Date().toISOString().slice(0,10);
document.getElementById('sale-date').value = today();
document.getElementById('pur-date').value = today();

const colSuppliers = collection(db, "suppliers");
const colCustomers = collection(db, "customers");
const colPurchases = collection(db, "purchases");
const colPayments  = collection(db, "payments");
const colSales     = collection(db, "sales");

const fb = (id,msg,cls) => {{ const el=document.getElementById(id); el.textContent=msg; el.className="muted mono "+(cls||""); setTimeout(()=>el.textContent="",3000); }};

// datalists
onSnapshot(colSuppliers, snap => {{ document.getElementById('suppliersList').innerHTML = snap.docs.map(d=>`<option value="${{d.data().name}}">`).join(''); }});
onSnapshot(colCustomers, snap => {{ document.getElementById('customersList').innerHTML = snap.docs.map(d=>`<option value="${{d.data().name}}">`).join(''); }});
onSnapshot(colPurchases, snap => {{ 
  const models = [...new Set(snap.docs.map(d=>d.data().model))];
  document.getElementById('modelsList').innerHTML = models.map(m=>`<option value="${{m}}">`).join('');
}});

// add supplier
document.getElementById('btn-add-supplier').addEventListener('click', async ()=>{ 
  const name = document.getElementById('sup-name').value.trim();
  const phone = document.getElementById('sup-phone').value.trim();
  const notes = document.getElementById('sup-notes').value.trim();
  if(!name) return fb('sup-feedback',"اكتب اسم المورد","danger");
  await addDoc(colSuppliers, {{ name, phone, notes, createdAt: serverTimestamp() }});
  ['sup-name','sup-phone','sup-notes'].forEach(id=>document.getElementById(id).value="");
  fb('sup-feedback',"تمت إضافة المورد","success");
});

function makeSupplierLink(id){ const base = location.href.split('?')[0]; return `${{base}}?supplier=${{id}}&view=public`; }

onSnapshot(colSuppliers, async snap => {{ 
  const tbody = document.querySelector('#suppliers-table tbody'); tbody.innerHTML = "";
  for (const d of snap.docs){{ 
    const s = d.data(); const sid = d.id;
    let totalPurch=0, totalPays=0;
    onSnapshot(query(colPurchases, where("supplierId","==",sid)), ps=>{{ totalPurch = ps.docs.reduce((a,b)=> a + ((+b.data().qty||0)*(+b.data().cost||0)), 0); document.getElementById('dummyTP')?.remove(); }});
    onSnapshot(query(colPayments, where("supplierId","==",sid)), py=>{{ totalPays  = py.docs.reduce((a,b)=> a + (+b.data().amount||0), 0); }});
    const tr = document.createElement('tr');
    const link = makeSupplierLink(sid);
    setInterval(()=>{{ const balance = totalPurch - totalPays; tr.innerHTML = `<td>${{s.name}}</td><td>${{s.phone||'—'}}</td><td>${{fmt(totalPurch)}}</td><td>${{fmt(totalPays)}}</td><td class="${{balance>0?'warning':'success'}}">${{fmt(balance)}}</td><td><input class="mono" style="width:100%" value="${{link}}" readonly></td>`; }}, 500);
    tbody.appendChild(tr);
  }}
}});

// add customer
document.getElementById('btn-add-customer').addEventListener('click', async ()=>{ 
  const name = document.getElementById('cus-name').value.trim();
  const phone = document.getElementById('cus-phone').value.trim();
  const city = document.getElementById('cus-city').value.trim();
  const address = document.getElementById('cus-address').value.trim();
  if(!name) return fb('cus-feedback',"اكتب اسم الزبون","danger");
  await addDoc(colCustomers, {{ name, phone, city, address, createdAt: serverTimestamp() }});
  ['cus-name','cus-phone','cus-city','cus-address'].forEach(id=>document.getElementById(id).value="");
  fb('cus-feedback',"تمت إضافة الزبون","success");
});

onSnapshot(colCustomers, snap => {{ 
  const tbody = document.querySelector('#customers-table tbody'); tbody.innerHTML="";
  snap.docs.forEach(d=>{{ const c=d.data(); const tr=document.createElement('tr'); tr.innerHTML=`<td>${{c.name}}</td><td>${{c.phone||'—'}}</td><td>${{c.city||'—'}}</td><td>${{c.address||'—'}}</td>`; tbody.appendChild(tr); }});
}});

// add purchase
document.getElementById('btn-add-purchase').addEventListener('click', async ()=>{ 
  const date = document.getElementById('pur-date').value || new Date().toISOString().slice(0,10);
  const supplierName = document.getElementById('pur-supplier').value.trim();
  const model = document.getElementById('pur-model').value.trim();
  const color = document.getElementById('pur-color').value.trim();
  const size = +document.getElementById('pur-size').value || 0;
  const qty = +document.getElementById('pur-qty').value || 0;
  const cost = +document.getElementById('pur-cost').value || 0;
  const notes = document.getElementById('pur-notes').value.trim();
  if(!supplierName || !model || qty<=0) return fb('pur-feedback',"تحقق من المورد/الموديل/الكمية","danger");
  // ensure supplier doc
  let supplierId = null;
  await new Promise(res=> onSnapshot(query(colSuppliers, where("name","==", supplierName)), async s=>{ 
    if(s.empty) {{ const nd = await addDoc(colSuppliers, {{ name: supplierName, phone:"", notes:"", createdAt: serverTimestamp() }}); supplierId = nd.id; }}
    else supplierId = s.docs[0].id; res();
  }});
  await addDoc(colPurchases, {{ date, supplierId, model, color, size, qty, cost, notes, createdAt: serverTimestamp() }});
  ['pur-model','pur-color','pur-size','pur-qty','pur-cost','pur-notes'].forEach(id=>document.getElementById(id).value="");
  document.getElementById('pur-qty').value=1;
  fb('pur-feedback',"تم تسجيل الشراء","success");
});

onSnapshot(query(colPurchases, orderBy("createdAt","desc")), async snap => {{ 
  const tbody = document.querySelector('#purchases-table tbody'); tbody.innerHTML="";
  for (const d of snap.docs){{ 
    const p = d.data();
    let supplierName = "—";
    if(p.supplierId){{ const sdoc = await getDoc(doc(db,"suppliers",p.supplierId)); if(sdoc.exists()) supplierName = sdoc.data().name; }}
    const total = (+p.qty||0)*(+p.cost||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${{p.date||''}}</td><td>${{supplierName}}</td><td class="mono">${{p.model}}</td><td>${{p.color||'—'}}</td><td>${{p.size||'—'}}</td><td>${{p.qty}}</td><td>${{fmt(p.cost)}}</td><td>${{fmt(total)}}</td><td>${{p.notes||'—'}}</td>`;
    tbody.appendChild(tr);
  }}
}});

// add sale
document.getElementById('btn-add-sale').addEventListener('click', async ()=>{ 
  const s = {{
    date: document.getElementById('sale-date').value || new Date().toISOString().slice(0,10),
    order: document.getElementById('sale-order').value.trim(),
    customer: document.getElementById('sale-customer').value.trim(),
    phone: document.getElementById('sale-phone').value.trim(),
    model: document.getElementById('sale-model').value.trim(),
    color: document.getElementById('sale-color').value.trim(),
    size: +document.getElementById('sale-size').value || 0,
    qty: +document.getElementById('sale-qty').value || 0,
    price: +document.getElementById('sale-price').value || 0,
    discount: +document.getElementById('sale-discount').value || 0,
    shipping: +document.getElementById('sale-ship').value || 0,
    notes: document.getElementById('sale-notes').value.trim(),
    createdAt: serverTimestamp()
  }};
  if(!s.model || s.qty<=0 || s.price<0) return fb('sale-feedback',"تحقق من الموديل/الكمية/السعر","danger");
  await addDoc(colSales, s);
  if(s.customer){{
    onSnapshot(query(colCustomers, where("name","==", s.customer)), async cs=>{{ if(cs.empty) await addDoc(colCustomers, {{ name:s.customer, phone:s.phone, city:"", address:"", createdAt: serverTimestamp() }}); }});
  }}
  fb('sale-feedback',"تم إضافة البيع","success");
  ['sale-order','sale-customer','sale-phone','sale-model','sale-color','sale-size','sale-qty','sale-price','sale-discount','sale-ship','sale-notes'].forEach(id=>{{ const el=document.getElementById(id); if(id==='sale-qty') el.value=1; else if(id==='sale-discount'||id==='sale-ship') el.value=0; else el.value=''; }});
  document.getElementById('sale-date').value = new Date().toISOString().slice(0,10);
});

let cachedPurchases = [], cachedSales = [];
onSnapshot(colPurchases, snap => {{ cachedPurchases = snap.docs.map(d=>d.data()); refreshDashboard(); refreshSalesTable(); }});
onSnapshot(colSales, snap => {{ cachedSales = snap.docs.map(d=>d.data()); refreshDashboard(); refreshSalesTable(); }});

function avgCost(model){{
  const items = cachedPurchases.filter(p=>p.model===model);
  if(items.length===0) return 0;
  const totalQty = items.reduce((a,b)=> a + (+b.qty||0), 0);
  const totalCost = items.reduce((a,b)=> a + ((+b.qty||0)*(+b.cost||0)), 0);
  return totalQty>0 ? totalCost/totalQty : 0;
}}

function refreshSalesTable(){{
  const tbody = document.querySelector('#sales-table tbody'); tbody.innerHTML="";
  const sales = cachedSales.slice().sort((a,b)=> (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  sales.forEach(s=>{{ 
    const netUnit = s.qty>0 ? (s.price - (s.discount/s.qty)) : s.price;
    const totalSale = netUnit * s.qty;
    const unitCost = avgCost(s.model);
    const totalCost = unitCost * s.qty + s.shipping;
    const gross = totalSale - totalCost;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${{s.date||''}}</td><td class="mono">${{s.order||'—'}}</td><td>${{s.customer||'—'}}</td><td>${{s.phone||'—'}}</td><td class="mono">${{s.model}}</td><td>${{s.color||'—'}}</td><td>${{s.size||'—'}}</td><td>${{s.qty}}</td><td>${{fmt(s.price)}}</td><td>${{fmt(s.discount)}}</td><td>${{fmt(s.shipping)}}</td><td>${{fmt(totalSale)}}</td><td>${{fmt(totalCost)}}</td><td class="${{gross>=0?'success':'danger'}}">${{fmt(gross)}}</td>`;
    tbody.appendChild(tr);
  }});
}}

function refreshDashboard(){{
  let totalSales=0, totalCOGS=0;
  cachedSales.forEach(s=>{{ 
    const netUnit = s.qty>0 ? (s.price - (s.discount/s.qty)) : s.price;
    const totalSale = netUnit * s.qty;
    const unitCost = avgCost(s.model);
    const totalCost = unitCost * s.qty + s.shipping;
    totalSales += totalSale; totalCOGS += totalCost;
  }});
  const gross = totalSales - totalCOGS;
  const margin = totalSales>0 ? gross/totalSales : 0;
  document.getElementById('stat-total-sales').textContent = fmt(totalSales);
  document.getElementById('stat-total-cogs').textContent = fmt(totalCOGS);
  document.getElementById('stat-gross-profit').textContent = fmt(gross);
  document.getElementById('stat-margin').textContent = percent(margin);
}}

// Public supplier
async function tryPublicSupplierView(){{
  const params = new URLSearchParams(location.search);
  const supId = params.get('supplier'); const view = params.get('view');
  if(view!=='public' || !supId) return;
  document.querySelector('nav').hidden = true;
  ['dashboard','sales','purchases','suppliers','customers'].forEach(id=>{{ const el=document.getElementById(id); if(el) el.hidden=true; }});
  document.getElementById('public-supplier').hidden=false;

  const sdoc = await getDoc(doc(db,"suppliers", supId));
  if(!sdoc.exists()) {{ document.getElementById('public-supplier').innerHTML='<div class="warning">المورد غير موجود.</div>'; return; }}
  const sup = sdoc.data();
  document.getElementById('pub-sup-name').textContent = sup.name;
  document.getElementById('pub-sup-phone').textContent = sup.phone || '—';

  let totalPurch=0, totalPays=0;
  onSnapshot(query(colPurchases, where("supplierId","==",supId), orderBy("createdAt","desc")), ps=>{{
    const tbody = document.querySelector('#pub-purchases-table tbody'); tbody.innerHTML="";
    totalPurch=0;
    ps.docs.forEach(d=>{{ const p=d.data(); const tot=(+p.qty||0)*(+p.cost||0); totalPurch+=tot;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${{p.date||''}}</td><td class="mono">${{p.model}}</td><td>${{p.color||'—'}}</td><td>${{p.size||'—'}}</td><td>${{p.qty}}</td><td>${{fmt(p.cost)}}</td><td>${{fmt(tot)}}</td>`;
      tbody.appendChild(tr);
    }});
    document.getElementById('pub-total-purchases').textContent = fmt(totalPurch);
    document.getElementById('pub-balance').textContent = fmt(totalPurch - totalPays);
  }});
  onSnapshot(query(colPayments, where("supplierId","==",supId), orderBy("createdAt","desc")), py=>{{
    totalPays = py.docs.reduce((a,b)=> a + (+b.data().amount||0), 0);
    document.getElementById('pub-total-payments').textContent = fmt(totalPays);
    document.getElementById('pub-balance').textContent = fmt(totalPurch - totalPays);
  }});
}}
tryPublicSupplierView();
</script>
</body>
</html>
